from __future__ import unicode_literals
from xml.sax.saxutils import escape

from .abc import Writer

# Taken from https://mateam.net/html-escape-characters/ and then parsed table to auto generate the dictionary.
HTML_COMMON_ESCAPE_SEQUENCES = {
  "\t": "&Tab;",
  "\n": "&NewLine;",
  "\"": "&quot;",
  "\u0080": "&#128;",
  "\u0082": "&#130;",
  "\u0083": "&#131;",
  "\u0084": "&#132;",
  "\u0085": "&#133;",
  "\u0086": "&#134;",
  "\u0087": "&#135;",
  "\u0088": "&#136;",
  "\u0089": "&#137;",
  "\u008a": "&#138;",
  "\u008b": "&#139;",
  "\u008c": "&#140;",
  "\u008e": "&#142;",
  "\u0091": "&#145;",
  "\u0092": "&#146;",
  "\u0093": "&#147;",
  "\u0094": "&#148;",
  "\u0095": "&#149;",
  "\u0096": "&#150;",
  "\u0097": "&#151;",
  "\u0098": "&#152;",
  "\u0099": "&#153;",
  "\u009a": "&#154;",
  "\u009b": "&#155;",
  "\u009c": "&#156;",
  "\u009e": "&#158;",
  "\u009f": "&#159;",
  "\u00a0": "&nbsp;",
  "\u00a1": "&iexcl;",
  "\u00a2": "&cent;",
  "\u00a3": "&pound;",
  "\u00a4": "&curren;",
  "\u00a5": "&yen;",
  "\u00a6": "&brvbar;",
  "\u00a7": "&sect;",
  "\u00a8": "&uml;",
  "\u00a9": "&copy;",
  "\u00aa": "&ordf;",
  "\u00ab": "&laquo;",
  "\u00ac": "&not;",
  "\u00ad": "&shy;",
  "\u00ae": "&reg;",
  "\u00af": "&macr;",
  "\u00b0": "&deg;",
  "\u00b1": "&plusmn;",
  "\u00b2": "&sup2;",
  "\u00b3": "&sup3;",
  "\u00b4": "&acute;",
  "\u00b5": "&micro;",
  "\u00b6": "&dot;",
  "\u00b8": "&cedil;",
  "\u00b9": "&sup1;",
  "\u00ba": "&ordm;",
  "\u00bb": "&raquo;",
  "\u00bc": "&frac14;",
  "\u00bd": "&frac12;",
  "\u00be": "&frac34;",
  "\u00bf": "&iquest;",
  "\u00c0": "&Agrave;",
  "\u00c1": "&Aacute;",
  "\u00c2": "&Acirc;",
  "\u00c3": "&Atilde;",
  "\u00c4": "&Auml;",
  "\u00c5": "&Aring;",
  "\u00c6": "&AElig;",
  "\u00c7": "&Ccedil;",
  "\u00c8": "&Egrave;",
  "\u00c9": "&Eacute;",
  "\u00ca": "&Ecirc;",
  "\u00cb": "&Euml;",
  "\u00cc": "&Igrave;",
  "\u00cd": "&Iacute;",
  "\u00ce": "&Icirc;",
  "\u00cf": "&Iuml;",
  "\u00d0": "&ETH;",
  "\u00d1": "&Ntilde;",
  "\u00d2": "&Ograve;",
  "\u00d3": "&Oacute;",
  "\u00d4": "&Ocirc;",
  "\u00d5": "&Otilde;",
  "\u00d6": "&Ouml;",
  "\u00d7": "&times;",
  "\u00d8": "&Oslash;",
  "\u00d9": "&Ugrave;",
  "\u00da": "&Uacute;",
  "\u00db": "&Ucirc;",
  "\u00dc": "&Uuml;",
  "\u00dd": "&Yacute;",
  "\u00de": "&THORN;",
  "\u00df": "&szlig;",
  "\u00e0": "&agrave;",
  "\u00e1": "&aacute;",
  "\u00e2": "&acirc;",
  "\u00e3": "&atilde;",
  "\u00e4": "&auml;",
  "\u00e5": "&aring;",
  "\u00e6": "&aelig;",
  "\u00e7": "&ccedil;",
  "\u00e8": "&egrave;",
  "\u00e9": "&eacute;",
  "\u00ea": "&ecirc;",
  "\u00eb": "&euml;",
  "\u00ec": "&igrave;",
  "\u00ed": "&iacute;",
  "\u00ee": "&icirc;",
  "\u00ef": "&iuml;",
  "\u00f0": "&eth;",
  "\u00f1": "&ntilde;",
  "\u00f2": "&ograve;",
  "\u00f3": "&oacute;",
  "\u00f4": "&ocirc;",
  "\u00f5": "&otilde;",
  "\u00f6": "&ouml;",
  "\u00f7": "&divide;",
  "\u00f8": "&oslash;",
  "\u00f9": "&ugrave;",
  "\u00fa": "&uacute;",
  "\u00fb": "&ucirc;",
  "\u00fc": "&uuml;",
  "\u00fd": "&yacute;",
  "\u00fe": "&thorn;",
  "\u00ff": "&yuml;",
  "\u0100": "&Amacr;",
  "\u0101": "&amacr;",
  "\u0102": "&Abreve;",
  "\u0103": "&abreve;",
  "\u0104": "&Aogon;",
  "\u0105": "&aogon;",
  "\u0106": "&Cacute;",
  "\u0107": "&cacute;",
  "\u0108": "&Ccirc;",
  "\u0109": "&ccirc;",
  "\u010a": "&Cdot;",
  "\u010b": "&cdot;",
  "\u010c": "&Ccaron;",
  "\u010d": "&ccaron;",
  "\u010e": "&Dcaron;",
  "\u010f": "&dcaron;",
  "\u0110": "&Dstrok;",
  "\u0111": "&dstrok;",
  "\u0112": "&Emacr;",
  "\u0113": "&emacr;",
  "\u0114": "&Ebreve;",
  "\u0115": "&ebreve;",
  "\u0116": "&Edot;",
  "\u0117": "&edot;",
  "\u0118": "&Eogon;",
  "\u0119": "&eogon;",
  "\u011a": "&Ecaron;",
  "\u011b": "&ecaron;",
  "\u011c": "&Gcirc;",
  "\u011d": "&gcirc;",
  "\u011e": "&Gbreve;",
  "\u011f": "&gbreve;",
  "\u0120": "&Gdot;",
  "\u0121": "&gdot;",
  "\u0122": "&Gcedil;",
  "\u0123": "&gcedil;",
  "\u0124": "&Hcirc;",
  "\u0125": "&hcirc;",
  "\u0126": "&Hstrok;",
  "\u0127": "&hstrok;",
  "\u0128": "&Itilde;",
  "\u0129": "&itilde;",
  "\u012a": "&Imacr;",
  "\u012b": "&imacr;",
  "\u012c": "&Ibreve;",
  "\u012d": "&ibreve;",
  "\u012e": "&Iogon;",
  "\u012f": "&iogon;",
  "\u0130": "&Idot;",
  "\u0131": "&imath; &inodot;",
  "\u0132": "&IJlig;",
  "\u0133": "&ijlig;",
  "\u0134": "&Jcirc;",
  "\u0135": "&jcirc;",
  "\u0136": "&Kcedil;",
  "\u0137": "&kcedil;",
  "\u0138": "&kgreen;",
  "\u0139": "&Lacute;",
  "\u013a": "&lacute;",
  "\u013b": "&Lcedil;",
  "\u013c": "&lcedil;",
  "\u013d": "&Lcaron;",
  "\u013e": "&lcaron;",
  "\u013f": "&Lmidot;",
  "\u0140": "&lmidot;",
  "\u0141": "&Lstrok;",
  "\u0142": "&lstrok;",
  "\u0143": "&Nacute;",
  "\u0144": "&nacute;",
  "\u0145": "&Ncedil;",
  "\u0146": "&ncedil;",
  "\u0147": "&Ncaron;",
  "\u0148": "&ncaron;",
  "\u0149": "&napos;",
  "\u014a": "&ENG;",
  "\u014b": "&eng;",
  "\u014c": "&Omacr;",
  "\u014d": "&omacr;",
  "\u014e": "&Obreve;",
  "\u014f": "&obreve;",
  "\u0150": "&Odblac;",
  "\u0151": "&odblac;",
  "\u0152": "&OElig;",
  "\u0153": "&oelig;",
  "\u0154": "&Racute;",
  "\u0155": "&racute;",
  "\u0156": "&Rcedil;",
  "\u0157": "&rcedil;",
  "\u0158": "&Rcaron;",
  "\u0159": "&rcaron;",
  "\u015a": "&Sacute;",
  "\u015b": "&sacute;",
  "\u015c": "&Scirc;",
  "\u015d": "&scirc;",
  "\u015e": "&Scedil;",
  "\u015f": "&scedil;",
  "\u0160": "&Scaron;",
  "\u0161": "&scaron;",
  "\u0162": "&Tcedil;",
  "\u0163": "&tcedil;",
  "\u0164": "&Tcaron;",
  "\u0165": "&tcaron;",
  "\u0166": "&Tstrok;",
  "\u0167": "&tstrok;",
  "\u0168": "&Utilde;",
  "\u0169": "&utilde;",
  "\u016a": "&Umacr;",
  "\u016b": "&umacr;",
  "\u016c": "&Ubreve;",
  "\u016d": "&ubreve;",
  "\u016e": "&Uring;",
  "\u016f": "&uring;",
  "\u0170": "&Udblac;",
  "\u0171": "&udblac;",
  "\u0172": "&Uogon;",
  "\u0173": "&uogon;",
  "\u0174": "&Wcirc;",
  "\u0175": "&wcirc;",
  "\u0176": "&Ycirc;",
  "\u0177": "&ycirc;",
  "\u0178": "&Yuml;",
  "\u0192": "&fnof;",
  "\u02c6": "&circ;",
  "\u02dc": "&tilde;",
  "\u0391": "&Alpha;",
  "\u0392": "&Beta;",
  "\u0393": "&Gamma;",
  "\u0394": "&Delta;",
  "\u0395": "&Epsilon;",
  "\u0396": "&Zeta;",
  "\u0397": "&Eta;",
  "\u0398": "&Theta;",
  "\u0399": "&Iota;",
  "\u039a": "&Kappa;",
  "\u039b": "&Lambda;",
  "\u039c": "&Mu;",
  "\u039d": "&Nu;",
  "\u039e": "&Xi;",
  "\u039f": "&Omicron;",
  "\u03a0": "&Pi;",
  "\u03a1": "&Rho;",
  "\u03a3": "&Sigma;",
  "\u03a4": "&Tau;",
  "\u03a5": "&Upsilon;",
  "\u03a6": "&Phi;",
  "\u03a7": "&Chi;",
  "\u03a8": "&Psi;",
  "\u03a9": "&Omega;",
  "\u03b1": "&alpha;",
  "\u03b2": "&beta;",
  "\u03b3": "&gamma;",
  "\u03b4": "&delta;",
  "\u03b5": "&epsilon;",
  "\u03b6": "&zeta;",
  "\u03b7": "&eta;",
  "\u03b8": "&theta;",
  "\u03b9": "&iota;",
  "\u03ba": "&kappa;",
  "\u03bb": "&lambda;",
  "\u03bc": "&mu;",
  "\u03bd": "&nu;",
  "\u03be": "&xi;",
  "\u03bf": "&omicron;",
  "\u03c0": "&pi;",
  "\u03c1": "&rho;",
  "\u03c2": "&sigmaf;",
  "\u03c3": "&sigma;",
  "\u03c4": "&tau;",
  "\u03c5": "&upsilon;",
  "\u03c6": "&phi;",
  "\u03c7": "&chi;",
  "\u03c8": "&psi;",
  "\u03c9": "&omega;",
  "\u03d1": "&thetasym;",
  "\u03d2": "&upsih;",
  "\u03d6": "&piv;",
  "\u2002": "&ensp;",
  "\u2003": "&emsp;",
  "\u2009": "&thinsp;",
  "\u200c": "&zwnj;",
  "\u200d": "&zwj;",
  "\u200e": "&lrm;",
  "\u200f": "&rlm;",
  "\u2013": "&ndash;",
  "\u2014": "&mdash;",
  "\u2018": "&lsquo;",
  "\u2019": "&rsquo;",
  "\u201a": "&sbquo;",
  "\u201c": "&ldquo;",
  "\u201d": "&rdquo;",
  "\u201e": "&bdquo;",
  "\u2020": "&dagger;",
  "\u2021": "&Dagger;",
  "\u2022": "&bull;",
  "\u2026": "&hellip;",
  "\u2030": "&permil;",
  "\u2032": "&prime;",
  "\u2033": "&Prime;",
  "\u2039": "&lsaquo;",
  "\u203a": "&rsaquo;",
  "\u203e": "&oline;",
  "\u20ac": "&euro;",
  "\u2122": "&trade;",
  "\u2190": "&larr;",
  "\u2191": "&uarr;",
  "\u2192": "&rarr;",
  "\u2193": "&darr;",
  "\u2194": "&harr;",
  "\u21b5": "&crarr;",
  "\u2200": "&forall;",
  "\u2202": "&part;",
  "\u2203": "&exist;",
  "\u2205": "&empty;",
  "\u2207": "&nabla;",
  "\u2208": "&isin;",
  "\u2209": "&notin;",
  "\u220b": "&ni;",
  "\u220f": "&prod;",
  "\u2211": "&sum;",
  "\u2212": "&minus;",
  "\u2217": "&lowast;",
  "\u221a": "&radic;",
  "\u221d": "&prop;",
  "\u221e": "&infin;",
  "\u2220": "&ang;",
  "\u2227": "&and;",
  "\u2228": "&or;",
  "\u2229": "&cap;",
  "\u222a": "&cup;",
  "\u222b": "&int;",
  "\u2234": "&there4;",
  "\u223c": "&sim;",
  "\u2245": "&cong;",
  "\u2248": "&asymp;",
  "\u2260": "&ne;",
  "\u2261": "&equiv;",
  "\u2264": "&le;",
  "\u2265": "&ge;",
  "\u2282": "&sub;",
  "\u2283": "&sup;",
  "\u2284": "&nsub;",
  "\u2286": "&sube;",
  "\u2287": "&supe;",
  "\u2295": "&oplus;",
  "\u2297": "&otimes;",
  "\u22a5": "&perp;",
  "\u22c5": "&sdot;",
  "\u2308": "&lceil;",
  "\u2309": "&rceil;",
  "\u230a": "&lfloor;",
  "\u230b": "&rfloor;",
  "\u25ca": "&loz;",
  "\u2660": "&spades;",
  "\u2663": "&clubs;",
  "\u2665": "&hearts;",
  "\u2666": "&diams;"
}

class HtmlWriter(Writer):
    def __init__(self):
        self._fragments = []
    
    def text(self, text):
        self._fragments.append(_escape_html(text))
    
    def start(self, name, attributes=None):
        attribute_string = _generate_attribute_string(attributes)
        self._fragments.append("<{0}{1}>".format(name, attribute_string))

    def end(self, name):
        self._fragments.append("</{0}>".format(name))
    
    def self_closing(self, name, attributes=None):
        attribute_string = _generate_attribute_string(attributes)
        self._fragments.append("<{0}{1} />".format(name, attribute_string))
    
    def append(self, html):
        self._fragments.append(html)
    
    def as_string(self):
        return "".join(self._fragments)


def _escape_html(text):
    return escape(text, HTML_COMMON_ESCAPE_SEQUENCES)


def _generate_attribute_string(attributes):
    if attributes is None:
        return ""
    else:
        return "".join(
            ' {0}="{1}"'.format(key, _escape_html(attributes[key]))
            for key in sorted(attributes)
        )
